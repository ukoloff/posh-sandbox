CREATE DEFINER=`root`@`%` trigger insert_card_from_personal after update on personal for each row begin if not NEW.CODEKEY <=> OLD.CODEKEY then if (NEW.CODEKEY is not null and NEW.CODEKEY_DISP_FORMAT != 'PIN' and NEW.EMP_TYPE != 'QR_CODE' and convert(substr(HEX(NEW.CODEKEY), 3) using utf8) not regexp '^0*$') then if (select not exists(select 1 from card_bindings cb where cb.codekey = NEW.CODEKEY and cb.holder_id = NEW.ID)) then set @codekey_str_p = case when NEW.CODEKEY_DISP_FORMAT = 'W26' then convert(substr(HEX(NEW.CODEKEY), 3, 6) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W34' then convert(substr(HEX(NEW.CODEKEY), 3, 8) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W37' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W36' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W42' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W58' then convert(substr(HEX(NEW.CODEKEY), 3, 14) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W58DEC' then convert(substr(HEX(NEW.CODEKEY), 3, 14) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'PIN' then convert(substr(HEX(NEW.CODEKEY), 3, 6) using utf8) end; select id into @card_id_p from cards c where c.value = @codekey_str_p and c.format = NEW.CODEKEY_DISP_FORMAT limit 1; if (@card_id_p is null) then insert into cards (value, format, guest_applicable, name, mf_uid) values (@codekey_str_p, NEW.CODEKEY_DISP_FORMAT, IF(NEW.EMP_TYPE = 'GUEST', 1, 0), IF(NEW.EMP_TYPE = 'GUEST', NEW.NAME, null), NEW.MF_UID); select id into @card_id_p from cards c where c.value = @codekey_str_p and c.format = NEW.CODEKEY_DISP_FORMAT limit 1; else update cards c set c.mf_uid = NEW.MF_UID where c.id = @card_id_p; end if; insert into card_bindings values (NEW.ID, NEW.guest_id, @card_id_p, NEW.EMP_TYPE, NEW.CODEKEY, NEW.CODEKEY_DISP_FORMAT, NEW.EXPTIME, true, NEW.START_TIME); else update card_bindings cb set active = true, exp_time = NEW.EXPTIME, start_time = NEW.START_TIME, holder_type = NEW.EMP_TYPE where cb.codekey = NEW.CODEKEY and cb.holder_id = NEW.ID; end if; end if; update card_bindings cb set active = false, holder_type = NEW.EMP_TYPE where cb.codekey = OLD.CODEKEY and cb.holder_id = NEW.ID; end if; if not NEW.START_TIME <=> OLD.START_TIME then update card_bindings cb set start_time = NEW.START_TIME, holder_type = NEW.EMP_TYPE where cb.codekey = NEW.CODEKEY and cb.holder_id = NEW.ID; end if; if not NEW.EXPTIME <=> OLD.EXPTIME then update card_bindings cb set exp_time = NEW.EXPTIME, holder_type = NEW.EMP_TYPE where cb.codekey = NEW.CODEKEY and cb.holder_id = NEW.ID; end if; if not NEW.EMP_TYPE <=> OLD.EMP_TYPE then update card_bindings cb set holder_type = NEW.EMP_TYPE where cb.codekey = NEW.CODEKEY and cb.holder_id = NEW.ID; update cards c set guest_applicable = IF(NEW.EMP_TYPE = 'GUEST', 1, 0), name = IF(NEW.EMP_TYPE = 'GUEST', NEW.NAME, null) where c.id in (select cb.card_id from card_bindings cb where cb.holder_id = NEW.ID and cb.active = 1); end if; if not NEW.NAME <=> OLD.NAME then update cards c set name = IF(NEW.EMP_TYPE = 'GUEST', NEW.NAME, null) where c.id in (select cb.card_id from card_bindings cb where cb.holder_id = NEW.ID and cb.active = 1); end if; if not NEW.STATUS <=> OLD.STATUS then delete from card_bindings where holder_id = NEW.ID; delete from personal_keys where EMP_ID = NEW.ID; end if; if not NEW.MF_UID <=> OLD.MF_UID then update cards c set mf_uid = NEW.MF_UID where c.id in (select cb.card_id from card_bindings cb where cb.holder_id = NEW.ID and cb.active = 1 and cb.codekey = NEW.CODEKEY); end if; set @codekey_str_p = null; set @card_id_p = null; end;
CREATE DEFINER=`root`@`%` trigger insert_card_from_personal_after_insert after insert on personal for each row begin if (NEW.CODEKEY is not null and NEW.CODEKEY_DISP_FORMAT != 'PIN' and NEW.EMP_TYPE != 'QR_CODE' and convert(substr(HEX(NEW.CODEKEY), 3) using utf8) not regexp '^0*$') then set @codekey_str_p = case when NEW.CODEKEY_DISP_FORMAT = 'W26' then convert(substr(HEX(NEW.CODEKEY), 3, 6) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W34' then convert(substr(HEX(NEW.CODEKEY), 3, 8) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W37' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W36' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W42' then convert(substr(HEX(NEW.CODEKEY), 3, 10) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W58' then convert(substr(HEX(NEW.CODEKEY), 3, 14) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'W58DEC' then convert(substr(HEX(NEW.CODEKEY), 3, 14) using utf8) when NEW.CODEKEY_DISP_FORMAT = 'PIN' then convert(substr(HEX(NEW.CODEKEY), 3, 6) using utf8) end; select id into @card_id_p from cards c where c.value = @codekey_str_p and c.format = NEW.CODEKEY_DISP_FORMAT limit 1; if (@card_id_p is null) then insert into cards (value, format, guest_applicable, name, mf_uid) values (@codekey_str_p, NEW.CODEKEY_DISP_FORMAT, IF(NEW.EMP_TYPE = 'GUEST', 1, 0), IF(NEW.EMP_TYPE = 'GUEST', NEW.NAME, null), NEW.MF_UID); select id into @card_id_p from cards c where c.value = @codekey_str_p and c.format = NEW.CODEKEY_DISP_FORMAT limit 1; else update cards c set c.mf_uid = NEW.MF_UID where c.id = @card_id_p; end if; insert into card_bindings values (NEW.ID, NEW.guest_id, @card_id_p, NEW.EMP_TYPE, NEW.CODEKEY, NEW.CODEKEY_DISP_FORMAT, NEW.EXPTIME, true, NEW.START_TIME); end if; set @codekey_str_p = null; set @card_id_p = null; end;
